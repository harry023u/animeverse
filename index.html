<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeVerse - Track & Rate Anime</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --cursor-size: 20px;
            --cursor-glow-size: 300px;
            --cursor-glow-color: rgba(2, 132, 199, 0.1); /* sky-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A0A;
            color: #E5E7EB; /* gray-200 */
            cursor: none;
        }

        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1), transparent 30%),
                        radial-gradient(circle at 80% 90%, rgba(99, 102, 241, 0.1), transparent 35%);
            animation: aurora-flow 20s infinite alternate ease-in-out;
            will-change: background;
        }

        @keyframes aurora-flow {
            0% {
                background-position: 0% 50%, 50% 100%;
            }
            100% {
                background-position: 100% 50%, 0% 0%;
            }
        }

        #cursor {
            position: fixed;
            width: var(--cursor-size);
            height: var(--cursor-size);
            border: 2px solid white;
            border-radius: 50%;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            transition: width 0.2s, height 0.2s;
        }
        
        #cursor-glow {
            position: fixed;
            width: var(--cursor-glow-size);
            height: var(--cursor-glow-size);
            background: var(--cursor-glow-color);
            border-radius: 50%;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9998;
            filter: blur(80px);
            transition: transform 0.1s linear;
            will-change: transform;
        }

        a, button, .cursor-pointer {
            cursor: none;
        }

        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #111; }
        .dark ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #444; }

        .loader { border-top-color: #0ea5e9; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .gemini-loader { 
            width: 1em;
            height: 1em;
            border-radius: 50%;
            display: inline-block;
            border: 3px solid #ddd; 
            border-bottom-color: transparent; 
            animation: rotation 1s linear infinite; 
        }
        @keyframes rotation { to { transform: rotate(360deg); } }

        .fade-in-up {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in-up.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .anime-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 2px;
            background: linear-gradient(45deg, rgba(255,255,255,0), rgba(255,255,255,0));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            transition: background 0.3s ease-in-out;
        }
        
        .anime-card:hover::before {
             background: linear-gradient(45deg, #0ea5e9, #6366f1);
        }
    </style>
</head>
<body class="bg-black text-gray-200">
    <div id="cursor"></div>
    <div id="cursor-glow"></div>
    <div class="aurora-background"></div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken,
            getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, orderBy
        };
    </script>

    <!-- Header -->
    <header class="bg-black/50 backdrop-blur-lg sticky top-0 z-40 fade-in-up">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-black tracking-tighter text-white flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-sky-400" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1.25a1.25 1.25 0 00-2.5 0H8.25a1.25 1.25 0 00-2.5 0H4a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5z" />
                  <path d="M10 12a2.5 2.5 0 100 5 2.5 2.5 0 000-5z" />
                </svg>
                AnimeVerse
            </h1>
            <div class="flex items-center space-x-4">
                <div id="auth-container" class="flex items-center space-x-2">
                     <button id="login-btn" class="px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-600 transition-colors">Login</button>
                     <div id="user-profile" class="hidden items-center space-x-2">
                        <span id="user-id" class="text-sm font-medium"></span>
                        <button id="logout-btn" class="p-2 rounded-full hover:bg-gray-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                     </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4 md:p-6">
        <!-- Hero Section -->
        <section class="text-center my-16 md:my-24 fade-in-up" style="animation-delay: 100ms;">
            <h2 class="text-5xl md:text-7xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-indigo-400">Discover Your Next Obsession.</h2>
            <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-400">Track, rate, and discuss thousands of anime. Your definitive guide to the world of Japanese animation.</p>
            <div class="mt-8 relative max-w-lg mx-auto">
                <input type="text" id="searchInput" placeholder="Search for 'Attack on Titan'..." class="w-full bg-gray-900/50 border border-gray-700 rounded-full py-3 px-6 focus:outline-none focus:ring-2 focus:ring-sky-500 text-lg placeholder-gray-500">
                <svg class="w-6 h-6 absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </section>

        <!-- Filter Categories -->
        <div class="mb-8 fade-in-up" style="animation-delay: 200ms;">
            <h2 class="text-3xl font-bold mb-4 tracking-tight" id="page-title">Top Airing Anime</h2>
            <div class="flex flex-wrap gap-2">
                <button class="filter-btn active" data-filter="top/anime">All</button>
                <button class="filter-btn" data-status="watching">Watching</button>
                <button class="filter-btn" data-status="completed">Completed</button>
                <button class="filter-btn" data-status="onhold">On Hold</button>
                <button class="filter-btn" data-status="dropped">Dropped</button>
                <button class="filter-btn" data-status="plantowatch">Plan to Watch</button>
            </div>
             <style>
                .filter-btn {
                    padding: 8px 16px;
                    border-radius: 9999px;
                    background-color: rgba(38, 38, 38, 0.5);
                    border: 1px solid rgb(55 65 81);
                    color: #A1A1AA;
                    transition: all 0.2s;
                }
                .filter-btn:hover {
                    background-color: rgba(55, 65, 81, 0.7);
                    color: white;
                }
                .filter-btn.active {
                    background-color: #fff;
                    color: #000;
                    font-weight: 600;
                    border-color: #fff;
                }
            </style>
        </div>
        
        <!-- Anime Grid -->
        <div id="anime-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6 fade-in-up" style="animation-delay: 300ms;">
            <!-- Anime cards will be injected here -->
        </div>

        <!-- Loader -->
        <div id="loader" class="flex justify-center items-center py-20">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-700 h-32 w-32"></div>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="flex justify-center items-center space-x-4 mt-8">
            <!-- Pagination buttons will be injected here -->
        </div>

        <!-- Latest Community Reviews Section -->
        <section id="community-reviews-section" class="mt-24 fade-in-up" style="animation-delay: 400ms;">
            <h2 class="text-3xl font-bold mb-6 text-center tracking-tight">Latest Community Reviews</h2>
            <div id="latest-reviews-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Latest reviews will be injected here -->
                <p id="reviews-loader" class="col-span-full text-center text-gray-500">Loading latest reviews...</p>
            </div>
        </section>

    </main>

    <!-- Anime Detail Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm"></div>
        <div class="flex items-center justify-center min-h-screen p-4 text-center">
            <div id="modal-panel" class="relative bg-gray-900/70 backdrop-blur-xl border border-gray-700 rounded-2xl text-left overflow-hidden shadow-2xl shadow-sky-500/10 transform transition-all sm:my-8 sm:max-w-4xl w-full max-h-[90vh] opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                <div id="modal-content" class="overflow-y-auto max-h-[90vh] p-6">
                    <!-- Modal content will be injected here -->
                </div>
                <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://api.jikan.moe/v4';
            let currentPage = 1;
            let currentFilter = 'top/anime';
            let currentSearchQuery = '';
            let currentAnimeId = null;
            let initialDataLoaded = false;
 
             let auth, db;
             let unsubscribeReviews = null;
             let unsubscribeLatestReviews = null;
 
             const animeGrid = document.getElementById('anime-grid');
             const loader = document.getElementById('loader');
             const pageTitle = document.getElementById('page-title');
             const paginationContainer = document.getElementById('pagination');
             const searchInput = document.getElementById('searchInput');
             const filterButtons = document.querySelectorAll('.filter-btn');

            const modal = document.getElementById('modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalPanel = document.getElementById('modal-panel');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            const authContainer = document.getElementById('auth-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userProfile = document.getElementById('user-profile');
            const userIdDisplay = document.getElementById('user-id');
            
            // --- UI Enhancements ---
            const cursor = document.getElementById('cursor');
            const cursorGlow = document.getElementById('cursor-glow');

            window.addEventListener('mousemove', e => {
                const posX = e.clientX;
                const posY = e.clientY;
                cursor.style.transform = `translate(${posX}px, ${posY}px) translate(-50%, -50%)`;
                cursorGlow.style.transform = `translate(${posX}px, ${posY}px) translate(-50%, -50%)`;
            });

             const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
            
            // --- Gemini API Caller ---
            const callGeminiAPI = async (prompt) => {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                let response, retries = 3, delay = 1000;

                while (retries > 0) {
                    try {
                        response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                                return result.candidates[0].content.parts[0].text;
                            } else {
                                if (result.candidates?.[0]?.finishReason === 'SAFETY') { throw new Error("Content blocked due to safety settings."); }
                                throw new Error("Invalid response structure from Gemini API");
                            }
                        } else if (response.status === 429 || response.status >= 500) {
                            console.warn(`Gemini API request failed with status ${response.status}. Retrying...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; retries--;
                        } else { throw new Error(`Gemini API request failed with status ${response.status}`); }
                    } catch (error) {
                        console.error("Error calling Gemini API:", error); retries--; if (retries <= 0) throw error;
                        await new Promise(res => setTimeout(res, delay)); delay *= 2;
                    }
                }
                throw new Error("Gemini API request failed after multiple retries.");
            };

            // --- Firebase Initialization ---
            const initializeFirebase = async () => {
                // Your web app's Firebase configuration from your project
                const firebaseConfig = {
                  apiKey: "AIzaSyAVu5vhBE6OmWgSXUctB8WSERQW3t0mjT8",
                  authDomain: "anime-versewebsite.firebaseapp.com",
                  projectId: "anime-versewebsite",
                  storageBucket: "anime-versewebsite.firebasestorage.app",
                  messagingSenderId: "840291881589",
                  appId: "1:840291881589:web:0e81ab4e0159eec74d1e3c",
                  measurementId: "G-0688BH1S5Q"
                };

                try {
                    const app = window.firebase.initializeApp(firebaseConfig);
                    auth = window.firebase.getAuth(app);
                    db = window.firebase.getFirestore(app);

                    window.firebase.onAuthStateChanged(auth, (user) => {
                        if (user) {
                            // User is signed in. Update the UI.
                            updateUIForLoggedInUser(user);
                            // Load initial data if it hasn't been loaded yet.
                            if (!initialDataLoaded) {
                                initialDataLoaded = true;
                                fetchAnime(currentFilter, currentPage);
                                fetchLatestReviews();
                            }
                        } else {
                            // User is signed out. Show the login button.
                            updateUIForLoggedOutUser();
                            // Still load the public anime data from Jikan.
                            if (!initialDataLoaded) {
                                initialDataLoaded = true;
                                fetchAnime(currentFilter, currentPage);
                                // Don't fetch reviews as it requires auth.
                                 document.getElementById('reviews-loader').textContent = 'Please log in to see reviews.';
                            }
                        }
                    });
                    
                    // Attempt to sign in anonymously right after initialization
                    // The onAuthStateChanged listener will handle the result.
                    window.firebase.signInAnonymously(auth).catch(error => {
                        console.error("Initial anonymous sign-in failed:", error);
                        // The listener will catch the 'null' user state and update the UI.
                    });

                } catch (error) { console.error("Error initializing Firebase:", error); }
            };
            
            loginBtn.addEventListener('click', () => {
                window.firebase.signInAnonymously(auth).catch(e => {
                    console.error("Manual anonymous sign-in failed:", e);
                    alert("Login failed. Please check the console for details.");
                });
            });
            logoutBtn.addEventListener('click', () => window.firebase.signOut(auth).catch(e => console.error(e)));

            const updateUIForLoggedInUser = (user) => {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden'); userProfile.classList.add('flex');
                userIdDisplay.textContent = `User: ${user.uid.substring(0, 6)}...`;
                if(currentAnimeId) renderReviewForm(currentAnimeId);
            };

            const updateUIForLoggedOutUser = () => {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden'); userProfile.classList.remove('flex');
                userIdDisplay.textContent = '';
                const reviewFormContainer = document.getElementById('review-form-container');
                if(reviewFormContainer) reviewFormContainer.innerHTML = '<p class="text-center text-gray-500">Please log in to leave a review.</p>';
            };

            // --- API Fetching and Display ---
            const fetchAnime = async (endpoint, page = 1, query = '') => {
                showLoader();
                let url = query ? `${API_BASE_URL}/anime?q=${encodeURIComponent(query)}&page=${page}&sfw` : `${API_BASE_URL}/${endpoint}?page=${page}&sfw`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    displayAnime(data.data);
                    setupPagination(data.pagination);
                } catch (error) {
                    console.error("Failed to fetch anime:", error);
                    animeGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Could not load anime.</p>`;
                } finally { hideLoader(); }
            };
            
            const displayAnime = (animeList) => {
                animeGrid.innerHTML = '';
                if (!animeList || animeList.length === 0) {
                    animeGrid.innerHTML = `<p class="col-span-full text-center">No results found.</p>`;
                    return;
                }
                animeList.forEach(anime => {
                    const animeCard = document.createElement('div');
                    animeCard.className = 'anime-card relative group cursor-pointer';
                    animeCard.dataset.id = anime.mal_id;
                    const score = anime.score ? `⭐ ${anime.score.toFixed(2)}` : 'N/A';
                    
                    animeCard.innerHTML = `
                        <div class="relative overflow-hidden rounded-xl shadow-lg h-full">
                            <img src="${anime.images.webp.large_image_url}" alt="${anime.title}" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-3 w-full">
                                <h3 class="font-bold text-white text-md truncate" title="${anime.title}">${anime.title}</h3>
                                <p class="text-sm text-gray-300">${score}</p>
                            </div>
                        </div>
                    `;
                    animeCard.addEventListener('click', () => showAnimeDetails(anime.mal_id));
                    animeGrid.appendChild(animeCard);
                });
            };

            const showLoader = () => { animeGrid.innerHTML = ''; paginationContainer.innerHTML = ''; loader.classList.remove('hidden'); loader.classList.add('flex'); };
            const hideLoader = () => { loader.classList.add('hidden'); loader.classList.remove('flex'); };
            
            searchInput.addEventListener('keypress', (event) => {
                const query = event.target.value.trim();
                if (event.key === 'Enter' && query.length > 2) {
                    currentSearchQuery = query; currentPage = 1; currentFilter = '';
                    pageTitle.textContent = `Search results for "${query}"`;
                    document.querySelectorAll('.filter-btn.active').forEach(b => b.classList.remove('active'));
                    fetchAnime(null, 1, query);
                }
            });
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filter = button.dataset.filter;
                    const statusText = button.textContent;
                    
                    if (filter) { currentFilter = filter; pageTitle.textContent = `Top Airing Anime`; }
                    else { currentFilter = 'top/anime'; pageTitle.textContent = `${statusText} List`; }
                    
                    currentSearchQuery = ''; searchInput.value = ''; currentPage = 1;
                    fetchAnime(currentFilter, currentPage);
                });
            });

            const setupPagination = (paginationData) => {
                paginationContainer.innerHTML = '';
                if (!paginationData || !paginationData.has_next_page && currentPage === 1) return;
                
                const createButton = (text, disabled, onClick) => {
                    const button = document.createElement('button');
                    button.textContent = text;
                    button.disabled = disabled;
                    button.className = 'px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-md disabled:bg-gray-900 disabled:text-gray-500 disabled:cursor-not-allowed hover:bg-gray-700 transition-colors';
                    button.addEventListener('click', onClick);
                    return button;
                };

                const prevButton = createButton('« Prev', currentPage === 1, () => {
                    currentPage--; fetchAnime(currentFilter, currentPage, currentSearchQuery);
                });
                const nextButton = createButton('Next »', !paginationData.has_next_page, () => {
                    currentPage++; fetchAnime(currentFilter, currentPage, currentSearchQuery);
                });
                
                const pageIndicator = document.createElement('span');
                pageIndicator.textContent = `Page ${currentPage}`;
                pageIndicator.className = 'font-semibold text-gray-400';
                
                paginationContainer.append(prevButton, pageIndicator, nextButton);
            };

            const showAnimeDetails = async (id) => {
                modalContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-700 h-16 w-16"></div></div>`;
                openModal();
                currentAnimeId = id;
                try {
                    const response = await fetch(`${API_BASE_URL}/anime/${id}/full`);
                    const { data } = await response.json();
                    renderModalContent(data);
                    fetchReviews(id);
                } catch (error) {
                    modalContent.innerHTML = `<p class="text-center text-red-500">Could not load details.</p>`;
                }
            };
            
            const renderModalContent = (anime) => {
                 const genres = anime.genres.map(g => `<span class="bg-sky-900/50 text-sky-300 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full border border-sky-800">${g.name}</span>`).join('');
                 const studios = anime.studios.map(s => s.name).join(', ');
                 const streamingLinks = anime.streaming.map(s => `<a href="${s.url}" target="_blank" class="text-sky-400 hover:underline">${s.name}</a>`).join(', ') || 'N/A';

                 modalContent.innerHTML = `
                    <div>
                        <div class="border-b border-gray-700 mb-4">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button class="tab-btn active-tab" data-tab="details">Details</button>
                                <button class="tab-btn" data-tab="reviews">Reviews</button>
                            </nav>
                             <style>.tab-btn { padding: 1rem 0.25rem; border-bottom: 2px solid transparent; font-weight: 500; color: #9CA3AF; } .tab-btn.active-tab { color: #38BDF8; border-color: #38BDF8; }</style>
                        </div>
                        <div id="tab-panel-details" class="tab-panel">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1"><img src="${anime.images.webp.large_image_url}" alt="${anime.title}" class="rounded-lg shadow-lg w-full"></div>
                                <div class="md:col-span-2">
                                    <h2 class="text-3xl font-bold mb-2 text-white" id="modal-title">${anime.title_english || anime.title}</h2>
                                    <p class="text-lg text-gray-400 mb-4">${anime.title_japanese}</p>
                                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-4">
                                        <span class="flex items-center font-bold text-lg text-yellow-400">⭐ ${anime.score || 'N/A'}</span>
                                        <span class="text-gray-500">|</span><span>Ranked #${anime.rank || 'N/A'}</span><span class="text-gray-500">|</span><span>${anime.type}</span>
                                    </div>
                                    <div class="flex flex-wrap mb-4">${genres}</div>
                                    <h3 class="text-xl font-semibold mt-6 mb-2 text-white">Synopsis</h3>
                                    <p class="text-gray-400 text-sm leading-relaxed">${anime.synopsis?.replace(/\n/g, '<br>') || 'N/A'}</p>
                                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                                        <div><strong class="font-semibold text-white">Episodes:</strong> ${anime.episodes || 'N/A'}</div><div><strong class="font-semibold text-white">Status:</strong> ${anime.status}</div>
                                        <div><strong class="font-semibold text-white">Aired:</strong> ${anime.aired.string}</div><div><strong class="font-semibold text-white">Rating:</strong> ${anime.rating || 'N/A'}</div>
                                    </div>
                                    <div id="ai-recommendations-container" class="mt-6">
                                        <button id="get-recs-btn" class="w-full flex items-center justify-center px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600">✨ Find Similar Anime</button>
                                        <div id="recs-loader" class="mt-4 hidden text-center"><div class="gemini-loader mx-auto"></div><p class="text-sm mt-2">✨ Gemini is thinking...</p></div>
                                        <div id="recs-content" class="mt-4 hidden"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-panel-reviews" class="tab-panel hidden">
                             <div id="review-summary-container" class="mb-6"></div><div id="review-form-container" class="mb-6"></div>
                             <div id="reviews-list" class="space-y-4"><p class="text-center text-gray-500">Loading reviews...</p></div>
                        </div>
                    </div>`;

                 addTabListeners();
                 renderReviewForm(anime.mal_id);
                 document.getElementById('get-recs-btn').addEventListener('click', () => getAiRecommendations(anime));
            };

            const addTabListeners = () => {
                const tabButtons = document.querySelectorAll('.tab-btn');
                const tabPanels = document.querySelectorAll('.tab-panel');
                tabButtons.forEach(button => button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    tabPanels.forEach(panel => panel.classList.add('hidden'));
                    button.classList.add('active-tab');
                    document.getElementById(`tab-panel-${button.dataset.tab}`).classList.remove('hidden');
                }));
            };
            
            const getAiRecommendations = async (anime) => {
                const recsBtn = document.getElementById('get-recs-btn'), recsContent = document.getElementById('recs-content'), recsLoader = document.getElementById('recs-loader');
                recsBtn.disabled = true; recsLoader.classList.remove('hidden'); recsContent.classList.add('hidden');
                try {
                    const prompt = `Based on the anime '${anime.title_english || anime.title}' which has genres '${anime.genres.map(g => g.name).join(', ')}', recommend 3 similar anime. For each, provide a one-sentence reason. Format as a list with the anime title in bold.`;
                    const result = await callGeminiAPI(prompt);
                    recsContent.innerHTML = `<h4 class="text-lg font-semibold mb-2 text-white">✨ AI Recommendations</h4><div class="p-4 bg-gray-800/50 rounded-lg text-sm">${result.replace(/\*\*(.*?)\*\*/g, '<strong class="text-sky-400">$1</strong>').replace(/\n/g, '<br>')}</div>`;
                } catch (error) { recsContent.innerHTML = `<p class="text-red-500 text-center">Sorry, couldn't get recommendations. ${error.message}</p>`; }
                finally { recsLoader.classList.add('hidden'); recsContent.classList.remove('hidden'); recsBtn.classList.add('hidden'); }
            };
            
            const getReviewSummary = async (reviews) => {
                const summaryContainer = document.getElementById('review-summary-container'), summaryBtn = document.getElementById('summarize-reviews-btn');
                summaryBtn.disabled = true; summaryBtn.innerHTML = `<span class="gemini-loader mr-2"></span> ✨ Summarizing...`;
                try {
                    const prompt = `Summarize the general sentiment of these user reviews for an anime. Note common pros and cons. Be concise. Use bullet points.\n\nReviews:\n${reviews.map(r => `- "${r.text}" (Rating: ${r.rating}/10)`).join('\n')}`;
                    const result = await callGeminiAPI(prompt);
                    summaryContainer.innerHTML = `
                        <div class="relative bg-indigo-900/50 p-4 rounded-lg border border-indigo-700">
                            <button id="close-summary-btn" class="absolute top-1 right-2 text-gray-400 hover:text-white text-2xl">&times;</button>
                            <h4 class="text-lg font-semibold mb-2 text-indigo-200">✨ AI Review Summary</h4>
                            <p class="text-sm text-indigo-300">${result.replace(/\* /g, '• ').replace(/Pros:/g, '<strong class="text-green-400">Pros:</strong>').replace(/Cons:/g, '<strong class="text-red-400">Cons:</strong>').replace(/\n/g, '<br>')}</p>
                        </div>`;
                    document.getElementById('close-summary-btn').addEventListener('click', () => {
                        summaryContainer.innerHTML = ''; summaryBtn.classList.remove('hidden'); summaryBtn.disabled = false; summaryBtn.innerHTML = '✨ Summarize Reviews';
                    });
                } catch (error) { summaryContainer.innerHTML = `<p class="text-red-500 text-center p-4">Sorry, couldn't summarize reviews. ${error.message}</p>`; }
                finally { summaryBtn.classList.add('hidden'); }
            };

            const renderReviewForm = (animeId) => {
                 const container = document.getElementById('review-form-container'), user = auth.currentUser;
                 if (!container) return;
                 if (user && !user.isAnonymous) {
                     container.innerHTML = `
                        <form id="review-form" class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                             <h3 class="text-lg font-semibold mb-3 text-white">Leave a Review</h3>
                             <input type="number" name="rating" min="1" max="10" required class="w-full bg-gray-900 rounded-md p-2 mb-2 border border-gray-700" placeholder="Rating (1-10)">
                             <textarea name="reviewText" rows="3" required class="w-full bg-gray-900 rounded-md p-2 mb-2 border border-gray-700" placeholder="Your review..."></textarea>
                             <button type="submit" class="w-full px-4 py-2 bg-sky-500 text-white rounded-md hover:bg-sky-600">Submit Review</button>
                        </form>`;
                     document.getElementById('review-form').addEventListener('submit', (e) => handleReviewSubmit(e, animeId));
                 } else { container.innerHTML = '<p class="text-center text-gray-400 p-4 bg-gray-800/50 rounded-lg">Sign in to leave a review.</p>'; }
            }
            
            const handleReviewSubmit = async (e, animeId) => {
                e.preventDefault(); const user = auth.currentUser;
                if (!user || user.isAnonymous) { alert("You must be logged in to submit a review."); return; }
                const form = e.target;
                const appId = "anime-versewebsite"; // Hardcoded from your firebaseConfig
                try {
                    await window.firebase.addDoc(window.firebase.collection(db, `artifacts/${appId}/public/data/reviews`), {
                        animeId: Number(animeId), animeTitle: document.getElementById('modal-title')?.textContent || 'Unknown Anime', userId: user.uid,
                        username: `User ${user.uid.substring(0, 6)}`, rating: Number(form.rating.value), text: form.reviewText.value, createdAt: window.firebase.serverTimestamp()
                    });
                    form.reset();
                } catch (error) { console.error(error); alert("Failed to submit review."); }
            };
            
            const fetchReviews = (animeId) => {
                if (unsubscribeReviews) unsubscribeReviews();
                const appId = "anime-versewebsite"; // Hardcoded from your firebaseConfig
                const q = window.firebase.query(window.firebase.collection(db, `artifacts/${appId}/public/data/reviews`), window.firebase.where("animeId", "==", animeId));
                unsubscribeReviews = window.firebase.onSnapshot(q, (snapshot) => {
                    const reviews = []; snapshot.forEach((doc) => reviews.push({ id: doc.id, ...doc.data() }));
                    reviews.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    displayReviews(reviews);
                }, (error) => console.error(error));
            };

            const displayReviews = (reviews) => {
                const reviewsList = document.getElementById('reviews-list'), summaryContainer = document.getElementById('review-summary-container');
                if (!reviewsList) return;
                summaryContainer.innerHTML = ''; 
                if (reviews.length >= 3) {
                     const summarizeBtn = document.createElement('button');
                     summarizeBtn.id = 'summarize-reviews-btn'; summarizeBtn.innerHTML = '✨ Summarize Reviews';
                     summarizeBtn.className = 'w-full flex items-center justify-center mb-4 px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600';
                     summarizeBtn.onclick = () => getReviewSummary(reviews);
                     summaryContainer.appendChild(summarizeBtn);
                }
                if (reviews.length === 0) { reviewsList.innerHTML = `<p class="text-center text-gray-400">Be the first to leave a review!</p>`; return; }
                reviewsList.innerHTML = reviews.map(review => {
                    const date = review.createdAt ? new Date(review.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
                    return `
                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <p class="font-semibold text-sky-400">${review.username}</p><span class="text-sm text-gray-500">${date}</span>
                            </div>
                            <div class="flex items-center mb-2"><span class="font-bold text-yellow-400">⭐ ${review.rating}/10</span></div>
                            <p class="text-gray-300">${review.text}</p>
                        </div>`;
                }).join('');
            };

            const fetchLatestReviews = () => {
                if (unsubscribeLatestReviews) unsubscribeLatestReviews();
                const appId = "anime-versewebsite"; // Hardcoded from your firebaseConfig
                const q = window.firebase.query(window.firebase.collection(db, `artifacts/${appId}/public/data/reviews`), window.firebase.orderBy("createdAt", "desc"));
                unsubscribeLatestReviews = window.firebase.onSnapshot(q, (snapshot) => {
                    const reviews = []; snapshot.forEach((doc) => reviews.push({ id: doc.id, ...doc.data() }));
                    const loader = document.getElementById('reviews-loader');
                    if (reviews.length > 0) { loader.style.display = 'none'; displayLatestReviews(reviews.slice(0, 6)); }
                    else { loader.textContent = 'No reviews yet. Be the first!'; }
                }, (error) => console.error(error));
            };

            const displayLatestReviews = (reviews) => {
                const grid = document.getElementById('latest-reviews-grid'); if (!grid) return;
                grid.innerHTML = reviews.map(review => {
                     const date = review.createdAt ? new Date(review.createdAt.seconds * 1000).toLocaleDateString() : 'Just now';
                    return `
                        <div class="bg-gray-900/50 border border-gray-800 p-4 rounded-lg cursor-pointer hover:border-sky-500 transition-colors" data-anime-id="${review.animeId}">
                            <div class="flex items-center justify-between mb-2"><p class="font-semibold text-sky-400">${review.username}</p><span class="text-sm text-gray-500">${date}</span></div>
                            <p class="text-lg font-bold mb-2 text-white">${review.animeTitle}</p>
                             <div class="flex items-center mb-2"><span class="font-bold text-yellow-400">⭐ ${review.rating}/10</span></div>
                            <p class="text-gray-400 text-sm italic">"${review.text}"</p>
                        </div>`;
                }).join('');
                document.querySelectorAll('#latest-reviews-grid [data-anime-id]').forEach(card => {
                    card.addEventListener('click', () => showAnimeDetails(card.dataset.animeId));
                });
            };

            const openModal = () => {
                modal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
                setTimeout(() => {
                    modalBackdrop.classList.remove('opacity-0'); modalPanel.classList.remove('opacity-0', 'sm:scale-95');
                    modalBackdrop.classList.add('opacity-100'); modalPanel.classList.add('opacity-100', 'sm:scale-100');
                }, 10);
            };

            const closeModal = () => {
                modalBackdrop.classList.remove('opacity-100'); modalPanel.classList.remove('opacity-100', 'sm:scale-100');
                modalBackdrop.classList.add('opacity-0'); modalPanel.classList.add('opacity-0', 'sm:scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden'); document.body.style.overflow = '';
                    if (unsubscribeReviews) { unsubscribeReviews(); unsubscribeReviews = null; }
                    currentAnimeId = null;
                }, 300);
            };

            modalCloseBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });
            
            initializeFirebase();
        });
    </script>
</body>
</html>

